image: docker:24.0.6

services:
  - docker:25.0.2-dind

stages:
  - lint
  - test
  # - build
  - dockerize
  - retrain
  # - approve
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_HOST: tcp://docker:2376
  DOCKER_CERT_PATH: /certs/client
  DOCKER_TLS_VERIFY: 1
  AWS_DEFAULT_REGION: "ap-southeast-1"

before_script:
  - echo "ðŸ”§ Preparing job environment..."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§¹ LINT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lint:
  stage: lint
  image: python:3.10-slim
  script:
    - echo "ðŸ” Linting and formatting Plant Doctor service..."
    - pip install --upgrade pip flake8 black
    - black --check . || echo "âš ï¸ Code not formatted properly"
    - flake8 . --ignore=E501 || true
  only:
    - main
    - merge_requests
  allow_failure: true    # donâ€™t fail pipeline just for formatting

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§ª TEST
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
test:
  stage: test
  image: python:3.10-slim
  script:
    - echo "ðŸ§ª Running tests on plant-doctor-service..."
    - pip install --upgrade pip
    - pip install -r requirements.txt pytest
    - pytest || echo "âš ï¸ No tests yet"
  only:
    - main
    - merge_requests

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # ðŸ—ï¸ BUILD
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# build:
#   stage: build
#   script:
#     - echo "ðŸ—ï¸ Building Docker image for plant-doctor-service..."
#     - docker build -t plant-doctor:latest . # can remove this cos need to build again in next step actually
#   only:
#     - main

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ³ DOCKERIZE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dockerize:
  stage: dockerize
  script:
    - apk add --no-cache python3 py3-pip
    - pip install --upgrade pip awscli
    - echo "ðŸ³ Pushing plant-doctor-service Docker image to AWS ECR..."
    - docker build -t plant-doctor:latest .
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $(echo $ECR_REPO | cut -d'/' -f1)
    - docker tag plant-doctor:latest $ECR_REPO:latest
    - docker push $ECR_REPO:latest
  only:
    - main

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§  RETRAIN MODEL
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
retrain_model:
  stage: retrain
  image: python:3.10-slim
  before_script:
    # all env vars should come from GitLab CI/CD â†’ Settings â†’ Variables
    - pip install --upgrade pip "sagemaker>=2.197" boto3 python-dotenv tensorflow
    # - pip install --upgrade pip boto3 sagemaker python-dotenv tensorflow
  script:
    - echo "ðŸ§  Starting SageMaker model retraining..."
    - python sagemaker_retrain.py --epochs 5 --wait
  only:
    - main
  when: manual           # optional â†’ run retraining manually
  allow_failure: false

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # ðŸŸ¡ APPROVE (Manual)
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# approve:
#   stage: approve
#   when: manual
#   script:
#     - echo "ðŸŸ¡ Waiting for manual approval before ECS deploy..."
#   only:
#     - main

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸš€ DEPLOY
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deploy:
  stage: deploy
  script:
    - echo "ðŸš€ Deploying plant-doctor-service to ECS cluster..."
    # - aws ecs update-service \
    #     --cluster plant-doctor-cluster \
    #     --service plant-doctor-service \
    #     --force-new-deployment \
    #     --region $AWS_DEFAULT_REGION
  only:
    - main
  when: manual
